<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v5.min.js"></script>
<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>


<script>
  // set the dimensions and margins of the graph
  var margin = {
      top: 30,
      right: 30,
      bottom: 150,
      left: 60
    },
    width = 660 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

  // append the svg object to the body of the page
  var svg = d3.select("#my_dataviz")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
      "translate(" + margin.left + "," + margin.top + ")");

  //Read the data
  var total_list = [];
  var x_vals = [];
  var y_vals = [];

  var LINK='9800WLZSM8UU';//9800W1CHALH6
  var START='2020-08-06'
  var END=''//2020-08-05

  //${base64.encode(`${login}:${password}`)}
  d3.json(
    "https://tfc-app1.cl.cam.ac.uk/api/v1/traffic/btjourney/history/CAMBRIDGE_JTMS%7C"+LINK+"/?start_date="+START+"&end_date="+END, {
      headers: new Headers({
        "Authorization": `Token a62fb5390f070c129591b6ff19c0a8cf06440efc`
      }),
    }).then(json => {
      show_plot(json);
  });
  
  function show_plot(data){
    
    /* do something */
    console.log('loaded', data)
    data.request_data.forEach((element) => {
      total_list.push({
        "x": element.acp_ts,
        "y": element.travelTime,//normalTravelTime
        "y_2": element.normalTravelTime,//
        "time": element.time.slice(11, 20),
        "date":element.time.slice(0, 10)
      })
      x_vals.push(element.acp_ts);
      y_vals.push(element.travelTime);
      // console.log();
    })
    console.log(total_list.length);
    // Add X axis

    let min_x = Math.min(...x_vals);
     let min_y = Math.min(...y_vals);

    let max_x = Math.max(...x_vals);
    let max_y = Math.max(...y_vals);

    if (max_x - min_x < 86400) { //86400
      max_x = min_x + 86400;
    }
    let queried_date = new Date(min_x * 1000)

    let title_date = queried_date.toLocaleString()


    // console.log('domains', min_x, max_x, min_y, max_y);

    var x = d3.scaleLinear()
      .domain([min_x, max_x])
      .range([0, width]);

    var x_axis = d3.axisBottom(x).ticks(15).tickFormat(function (d, i) {

      let dateObject = new Date(d * 1000)

      let humanDateFormat = dateObject.toLocaleString() //2019-12-9 10:30:15

      // console.log(d, i, humanDateFormat)
      return humanDateFormat;//.slice(11, 20);
    });
    svg.append("text")
      .attr("x", (width / 2))
      .attr("y", 0 - (margin.top / 2))
      .attr("text-anchor", "middle")
      .style("font-size", "16px")
      .style("text-decoration", "none") //underline  
      .text("Travel time for "+LINK +" on "+ START+' '+ END);

    svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(x_axis)
      .selectAll("text")
      .style("text-anchor", "end")
      .attr("dx", "-.8em")
      .attr("dy", ".15em")
      .attr("transform", function (d) {
        return "rotate(-30)"
      });

    // Add Y axis
    let y_padding = 100;
    var y = d3.scaleLinear()
      .domain([min_y - y_padding, max_y + y_padding])
      .range([height, 0]);

    svg.append("g")
      .call(d3.axisLeft(y));
      
      // Add dots
svg.append('g')
      .selectAll("dot")
      .data(total_list)
      .enter()
      .append("circle")
      .attr("cx", function (d, i) {
        return x(d.x);
      }) //console.log(d,i,total_list[i].x,d.y);
      .attr("cy", function (d, i) {
        return y(d.y_2);
      })
      .attr("r", 1.5)
      .style("fill", "#ff0000")
      .style('opacity',0.1);

    // Add dots
    svg.append('g')
      .selectAll("dot")
      .data(total_list)
      .enter()
      .append("circle")
      .attr("cx", function (d, i) {
        return x(d.x);
      }) //console.log(d,i,total_list[i].x,d.y);
      .attr("cy", function (d, i) {
        return y(d.y);
      })
      .attr("r", 2.5)
      .style("fill", "#69b3a2");



    d3.selectAll('circle')
      .on('mouseover', function(d, i) {
        console.log(d)
        // Use D3 to select element, change color and size
        d3.select(this).attr("r", 10)
          .style("fill", "#ff00f9");
      })
      .on('mouseout', function(){
        // Use D3 to select element, change color and size
        d3.select(this).attr("r", 2.5)
          .style("fill", "#69b3a2");
      })

  }
</script>